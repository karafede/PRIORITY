
<!doctype html>
<html lang="en">

<style type="text/css">
    body {
            padding: 0;
            margin: 0;
			font-family: Arial, Helvetica, sans-serif;
        }
   
	#map {
	  height: 100%;
	}
	
	/* Optional: Makes the sample page fill the window. */
	html, body {
	  height: 100%;
	  margin: 0;
	  padding: 0;
	}


	.info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
	.legend { text-align: left; line-height: 10px; color: #555; font-size: 0.875em} .legend i { width: 10px; height: 10px; float: left; margin-right: 4px; opacity: 0.7; } 
	.legend_censuary { text-align: left; line-height: 10px; color: #555;  font-size: 10px;} 
	
	#heatmapContainerWrapper { width:100%; height:100%; position:absolute; background:rgba(0,0,0,.1);}
	#heatmapContainer { width:10%; height:10%; z-index: 700;}
	
	#heatmapLegend_N_vehicles { background:white; position:absolute; bottom:215px; right:0; padding:10px;  z-index: 700; font-size: 9px;}
	#min_vehicles { float:left; }
	#max_vehicles { float:right; }
	#heatmapLegend_stoptime { background:white; position:absolute; bottom:150px; right:0; padding:10px;  z-index: 700; font-size: 9px;}
	#min_stop_time { float:left; }
	#max_stop_time { float:right; }
	#heatmapLegend_tripdistance { background:white; position:absolute; bottom:85px; right:0; padding:10px;  z-index: 700; font-size: 9px;}
	#min_trip_distance { float:left; }
	#max_trip_distance { float:right; }
	#heatmapLegend_triptime { background:white; position:absolute; bottom:20px; right:0; padding:10px;  z-index: 700; font-size: 9px;}
	#min_trip_time { float:left; }
	#max_trip_time { float:right; }
	
	
	
	#refreshButton {
	  position: absolute;
	  top: 60px;
	  right: 20px;
	  padding: 10px;
	  z-index: 400;
	  color: #000000;
	  background-color:#FFFF00;
	}
	
	
	#home_locations {
	  position: absolute;
	  width: 100%;
	  top: 60px;
	  margin-top: 40px;
	  right: 20px;
	  padding: 10px;
	  z-index: 400;
	  color: #ffffff ;
	  background-color:#000099;
	}
	
	#refreshButton:hover{
		opacity: 0.8;
		cursor: pointer;
    }
	


	  html, body,  #map {
        width : 100%;
        height : 100%;
      }
	.box{	  
		width:15px;
		height:15px;
		border-radius:25px;
		display: inline-block;
		}
	

     /** sidebar menu **/
	.innerDiv{
		position: absolute;
		width: 10%;
		height: 15%;
		background-color: #b2b2ff;
		opacity: 0.8;
		margin-top:  1%;
		margin-left: 5%;
		z-index: 800;
		padding-top: 1%;
		text-overflow:ellipsis;
        overflow:hidden;
		
	}
	

	

 .button {
	    position: absolute;
		left: 2%;
		top: 80%;
		height: 8%;
		width: 7%
        min-width: 7%;
		margin-top: 30%;
		margin-left: 50%;
		z-index: 500;
	    border: none;
	    color: white;
	    padding: 20px;
	    text-align: center;
	    display: inline-block;
	    font-size: 1.5em;
	    margin: 10px 20px;		
	}

		
		
  header, nav {
    left: 2%;
	top: 85%;
  	z-index: 700;
	position: absolute;
	text-align: center;
	margin: 20px 0;
	padding: 10px;
	border-spacing: 5px;
  }

	nav a {
	  text-decoration: none;
	  background: #000000;  /* Black */
	  border-radius: 5px;
	  font-size: 1.2em;
	  color: white;
	  padding: 3px 8px;
	  display: table-cell;
	}
	
	
	nav .col_home {
		background-color: #6b0000;
	}
	
	nav .col_privata {
		background-color: #4CAF50;
	}
	
	
	nav .col_collettivo {
		background-color: #0000ff ;
	}
	
	nav .col_scenari {
		background-color: #ffa500 ;
	}
	
	
	nav .col_impatti {
		background-color: #76a5af ;
	}
	
	
	nav .IEA_statistics {
		background-color: #ededed ;
		color: blue;
	}
	
	
	
		

  /** submit lat lon and input text to Python **/
   main {
		background-color: rgba(51, 170, 51, .3); 
		left: 2%;
		top: 3%;
		z-index: 700;
		position: absolute;
		margin: 2px 0;
		padding: 5px;
		text-overflow:ellipsis;
        overflow:hidden;
    width: 380px;
    height: 500px
	}

	main div {
	  background: transparent; 
	  color: white;
	  padding: 1px;
	  margin: 5px auto;
	}
	

	main div:nth-child(1) {
	  width: 270px;
	  height: 0px;
	   background: transparent;
	}
	
	
    main div:nth-child(2) {
	  width: 270px;
	  height: 0px;
	   background: #326bbb;
	}
	

	main div:nth-child(3) {
      width: 170px;
	 background: transparent;
	}
	
	main div:nth-child(4) {
	  width: 270px;
	   height: 0px;
	   background: #326bbb;
	   float: center;
	}
	
	main div:nth-child(5) {
	  width: 270px;
	 background: transparent;
	}
	
	main div:nth-child(6) {
	   width: 270px;
	    background: transparent;
	}
	

	.inline-block-center {
	  text-align: center;
	}
	
	.flex-center {
	  display: flex;
	  justify-content: center;
	}
	

	h2 {
    margin: 0;
    padding: 0;
    font-weight: bold;
	line-height: 0.5em;
	}
	
	
	h3 {
    margin: 0;
    padding: 0;
	display: inline;
	}
	
	
	
	
	/* The Modal (background) */
	.modal {
	  display: none; /* Hidden by default */
	  position: absolute; /* Stay in place */
	  z-index: 700; /* Sit on top */
	  
	  position: absolute;
	   left: 20%;
		top: 4%;
	  width: 50%; /* Full width */
	  height: 70%; /* Full height */
	  overflow: auto; /* Enable scroll if needed */
	  background-color: rgb(0,0,0); /* Fallback color */
	  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content/Box */
	.modal-content {
	  z-index: 700;
	  top: 5%;
	  background-color: #fefefe;
	  margin: 5% auto; /* 15% from the top and centered */
	  padding: 1%;
	  border: 1px solid #888;
	  width: 100%; /* Could be more or less, depending on screen size */
	}

	/* The Close Button */
	.close {
	  color: #aaa;
	  float: right;
	  font-size: 28px;
	  font-weight: bold;
	}

	.close:hover,
	.close:focus {
	  color: black;
	  text-decoration: none;
	  cursor: pointer;
	}
	
	


.animation_link {
  font-size: 130%;
  color: blue;
  font-weight: bold;
}

.animation_link_heatmap {
  font-size: 130%;
  color: red;
  font-weight: bold;
}

.animation_link_IEA_STATS {
  font-size: 130%;
  color: #0f45d2;
  font-weight: bold;
}


	
	
</style>

<style>

.label {
  color: black;
  padding: 8px;
  font-family: Arial Black;
  font-weight: bold;
  font-size: 18px;
}


#.tpl_line {background-color: #2196F3;} /* Blue */


table, th, td {
  border:1px solid black;
   left: 20%;
}


table.center_table {
  margin-left: -15%; 
  //margin-left: 20%;
}



/* Center the loader (SPINNER) */
#loader {
  position: absolute;
  left: 50%;
  top: 50%;
  z-index: 1;
  width: 120px;
  height: 120px;
  margin: -76px 0 0 -76px;
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  // border-top: 16px solid #3498db;
  border-top: 16px solid blue;
  border-right: 16px solid green;
  border-bottom: 16px solid red;
  border-right: 16px solid yellow;
  border-left: 16px solid pink;
  -webkit-animation: spin 2s linear infinite;
  animation: spin 2s linear infinite;
}

@-webkit-keyframes spin {
  0% { -webkit-transform: rotate(0deg); }
  100% { -webkit-transform: rotate(360deg); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Add animation to "page content" */
.animate-bottom {
  position: relative;
  -webkit-animation-name: animatebottom;
  -webkit-animation-duration: 1s;
  animation-name: animatebottom;
  animation-duration: 1s
}

@-webkit-keyframes animatebottom {
  from { bottom:-100px; opacity:0 } 
  to { bottom:0px; opacity:1 }
}

@keyframes animatebottom { 
  from{ bottom:-100px; opacity:0 } 
  to{ bottom:0; opacity:1 }
}

#myDiv {
  display: none;
  text-align: center;
}



div#loading {
    display: none;
	position: absolute;
	left: 50%;
    top: 50%;
    z-index: 700;
	width: 270px;
	height: 270px;
	 margin: -76px 0 0 -76px;
    background: url(/static/loadingimage_TPL.gif) no-repeat;
    cursor: wait;
 }
 
 /* Button changing color when clicked */
 input.btn_color:active { background:yellow; } 
 
 
     /* custom primary buttons */
    
    .btn-primary {
        color: #212529;
        background-color: white ;
        border-color: #5bc2c2
    }
    
    .btn-primary:hover {
        color: #212529;
        background-color: #52bebe;
        border-color: #8ad3d3
    }
    
    .btn-primary:focus,
    .btn-primary.focus {
        box-shadow: 0 0 0 .2rem rgba(91, 194, 194, 0.5)
    }
    
    .btn-primary.disabled,
    .btn-primary:disabled {
        color: #212529;
        background-color: #7cc;
        border-color: #5bc2c2
    }
    
    .btn-primary:not(:disabled):not(.disabled):active,
    .btn-primary:not(:disabled):not(.disabled).active,
    .show>.btn-primary.dropdown-toggle {
        color: #212529;
        background-color: #9cdada;
        border-color: #2e7c7c
    }
    
    .btn-primary:not(:disabled):not(.disabled):active:focus,
    .btn-primary:not(:disabled):not(.disabled).active:focus,
    .show>.btn-primary.dropdown-toggle:focus {
        box-shadow: 0 0 0 .2rem rgba(91, 194, 194, 0.5)
    }
    
    .btn-outline-primary {
        color: #000000;
        background-color: yellow;
        background-image: none;
        border-color: #7cc;
    }
    
    .btn-outline-primary:hover {
        color: #222;
        background-color: #8ad3d3;
        border-color: #7cc
    }
    
    .btn-outline-primary:focus,
    .btn-outline-primary.focus {
        box-shadow: 0 0 0 .2rem rgba(119, 204, 204, 0.5)
    }
    
    .btn-outline-primary.disabled,
    .btn-outline-primary:disabled {
        color: #7cc;
        background-color: transparent
    }
    
    .btn-outline-primary:not(:disabled):not(.disabled):active,
    .btn-outline-primary:not(:disabled):not(.disabled).active,
    .show>.btn-outline-primary.dropdown-toggle {
        color: #212529;
        background-color: #8ad3d3;
        border-color: #7cc
    }
    
    .btn-outline-primary:not(:disabled):not(.disabled):active:focus,
    .btn-outline-primary:not(:disabled):not(.disabled).active:focus,
    .show>.btn-outline-primary.dropdown-toggle:focus {
        box-shadow: 0 0 0 .2rem rgba(119, 204, 204, 0.5)
    }


.btn_heatmaps {border: none;
			  background-color: blue;
			  padding: 12px 48px 12px 24px;
			  border-radius: 4px;
			  color: #fff;
			  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='7.41' height='12' viewBox='0 0 7.41 12'%3E%3Cpath d='M10,6,8.59,7.41,13.17,12,8.59,16.59,10,18l6-6Z' transform='translate(-8.59 -6)' fill='%23fff'/%3E%3C/svg%3E");
			  background-repeat: no-repeat;
			  background-position: right 24px center;
			  font-size: 20px;
			  font-weight: bold;
			  text-align: center;
			   left: 80%;
			   top: 85%;}
		   
.btn_animation {width: 45%;
	  height:50px;
	  font-size: 18px;
	  font-weight: bold;
	  text-align: center;
	  color:blue}
	   
		   

   .select{
		width:  15%;
		height: 30px;
		font-size: 18px;
		font-weight: bold;}
		
		
 
 
 #form-wrapper {
  width: 60%;
  height: 12%;
  margin: 0 auto;
  text-align: center;
  display:flex;
}
#form1 {
  width: 50%;
  display: inline-block;
  min-width:200px;
}
#form2 {
  width: 50%;
  display: inline-block;
  min-width:200px;
   background: #66b266;
  height:100%;
}

.flex {
   display: flex;
   flex-direction: row;
}

div.c {
	  text-align: center;
}


input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
    /* display: none; <- Crashes Chrome on hover */
    -webkit-appearance: none;
    margin: 0; /* <-- Apparently some margin are still there even though it's hidden */
}

 
 
 input[type="radio"] {
  -ms-transform: scale(1.5); /* IE 9 */
  -webkit-transform: scale(1.5); /* Chrome, Safari, Opera */
  transform: scale(1.5);
}
	

	

</style>

</head>
  <meta name="description" content="Leaflet Template">
  <title>RdS-ENEA</title>
  <!--meta name="viewport" content="initial-scale=1.0"-->
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <meta charset="utf-8">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
 </head>
 
 
 <!--start the SPINNER or LOADER-->
<div id="loader"></div>


<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">


<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />


 
 
 <!--start the SPINNER or LOADER-->
<!--div id="loader"></div-->


<body>

<div id="loading"></div>
<main class="inline-block-center">


<!--p><i><b>Heatmaps (private mobility)</i></b></p-->
 <!--p><h3>Timeline heatmaps (by hour)</h3></p-->

  <h2 style="font-weight: bold; line-height: 1em;">Timeline heatmaps</h2> 
    <h2 style="font-weight: bold; line-height: 1em;">(by hour)</h2> 

<br>

<!--form method="POST" action="/timeline_heatmaps_hourly/">
<span class="label tpl_line">Day:</span>
  <input type="date"   value="2019-10-09"  id="FCD-day" name="FCD_day">
  <input type="submit" onclick="$('#loading').show();">
</form-->


<form id="mainform" action="/timeline_heatmaps_hourly" method="POST" >
	   <input type="text" id="daterange"  name="daterange" onchange="myFunction_daterange(event)" value="     ___from___to___" />
	   <button type="submit">enter</button><br><br>
	</form>


<!--insert new line-->
<br>

 <p><h3>Please be patient for at least couple of minutes</h3></p>







<ul>
{% for item in data_timeline %}
<table class="center_table" style="width:100%">
<tr>
    <th>Day</th>
    <th>hour</th>
  </tr>
  <tr>
    <td>{{item.FCD_day}}</td>
    <!--td>{{item.hour}}</td-->
  </tr>
</table>
{% endfor %}
</ul>

<!--div class="break_line_1"></div-- >
<!--div class="break_line"></div-->





</main>





<nav role='navigation'>
  <a class="col_home" href="/home_page/">Home</a>
  <a class="col_privata" href="/mob_privata_page/" style="color:#ffffff;">Private Mobility</a>
  <!--img border="0" alt="W3Schools" src="/static/img/icone_mezzi_priv.png" width="30" height="30"-->
  <a class="col_collettivo" href="/public_transport_page/">Public Transport</a>
  <a class="col_scenari" href="/TRIP_LEGS/">Avoid-Shift measures</a>
  <a href="/charging_infrastructure_OSM/">EVs Charging Profile</a>
  <a class="col_impatti" href="/public_transport_page/">Impacts</a>
  <a class="IEA_statistics"  onclick="$('#loading').show();" href="/IEA_STATS_show/">statistics IEA</a>
</nav>  



  
<!-- Load data .geojson --> 
<!-- ZMU zones with population data -->
<script src="{{ url_for('static', filename='zmu_aggr_POP_ROMA_2011.geojson') }}" /></script>
<!-- POINTS of INTERESTS (PARKINGs) -->
<script src="{{ url_for('static', filename='POIS_parking.geojson') }}" /></script>
<!-- POINTS of INTERESTS (all AMENITIES) -->
<script src="{{ url_for('static', filename='layer_POIS_amenities.geojson') }}" /></script>
<!-- POINTS of INTERESTS (all BUILDINGS) -->
<script src="{{ url_for('static', filename='layer_POIS_residential.geojson') }}" /></script>
<!-- ALL POINTS of INTERESTS (all BUILDINGS and AMENITIES) -->
<script src="{{ url_for('static', filename='zmu_POIS_ROMA_2011.geojson') }}" /></script>

<script src="{{ url_for('static', filename='heatmap.js') }}" /></script>
<script src="{{ url_for('static', filename='heatmap_triptime.js') }}" /></script>
<script src="{{ url_for('static', filename='heatmap_stoptime.js') }}" /></script>
<script src="{{ url_for('static', filename='heatmap_tripdistance.js') }}" /></script>

<script src="{{ url_for('static', filename='leaflet-heatmap.js') }}" /></script>
<script src="{{ url_for('static', filename='leaflet-heatmap_triptime.js') }}" /></script>
<script src="{{ url_for('static', filename='leaflet-heatmap_stoptime.js') }}" /></script>
<script src="{{ url_for('static', filename='leaflet-heatmap_tripdistance.js') }}" /></script>

<script src="{{ url_for('static', filename='gridded_n_vehicles_destination.txt') }}" /></script>	
<script src="{{ url_for('static', filename='gridded_triptime_destination.txt') }}" /></script>	
<script src="{{ url_for('static', filename='gridded_stoptime_destination.txt') }}" /></script>	
<script src="{{ url_for('static', filename='gridded_tripdistance_destination.txt') }}" /></script>	
<script src="{{ url_for('static', filename='min_n_vehicles.txt') }}" /></script>	
<script src="{{ url_for('static', filename='max_n_vehicles.txt') }}" /></script>
<script src="{{ url_for('static', filename='min_triptime.txt') }}" /></script>
<script src="{{ url_for('static', filename='max_triptime.txt') }}" /></script>	
<script src="{{ url_for('static', filename='min_stoptime.txt') }}" /></script>
<script src="{{ url_for('static', filename='max_stoptime.txt') }}" /></script>	
<script src="{{ url_for('static', filename='min_tripdistance.txt') }}" /></script>
<script src="{{ url_for('static', filename='max_tripdistance.txt') }}" /></script>	
		


  <div id="heatmapContainerWrapper">
      <div id="heatmapContainer">


      </div>
      <div id="heatmapLegend_N_vehicles">
		<h2 style="font-size: 16px;  font-family: Arial; font-weight: bold;">Number of Vehicles</h2>
        <span id="min_vehicles"></span>
        <span id="max_vehicles"></span>
        <img id="gradient" src="" style="width:100%" />
      </div>
    </div>
	
	
	</div>
      <div id="heatmapLegend_stoptime">
		 <h2 style="font-size: 16px;  font-family: Arial; font-weight: bold;">Stop Time (min)</h2>
        <span id="min_stop_time"></span>
        <span id="max_stop_time"></span>
        <img id="gradient_stoptime" src="" style="width:100%" />
      </div>
    </div>
	
	
	 </div>
      <div id="heatmapLegend_tripdistance">
		<h2 style="font-size: 16px;  font-family: Arial; font-weight: bold;">Trip Distance (km)</h2>
        <span id="min_trip_distance"></span>
        <span id="max_trip_distance"></span>
        <img id="gradient_tripdistance" src="" style="width:100%" />
      </div>
    </div>
	
	
	
	 </div>
      <div id="heatmapLegend_triptime">
		<h2 style="font-size: 16px;  font-family: Arial; font-weight: bold;">Trip Time (min))</h2>
        <span id="min_trip_time"></span>
        <span id="max_trip_time"></span>
        <img id="gradient_triptime" src="" style="width:100%" />
      </div>
    </div>
	
	
	
	
<!--we are inside the area of the map-->
<div id="map">  </div>
		


  <script>

     // ----------------------------------------------------	 
	   
	   
	   window.onload = function() {
        // helper function
        function $(id) {
          return document.getElementById(id);
        };
		

      // Hack to autoset the iframe height.
      window.addEventListener("load", function() {
        window.setTimeout(function() {
          setFrameHeight(document.documentElement.clientHeight)
        }, 0);
      });
	  
	  
	//  date range picker //
	$(function() {
	  $('input[name="daterange"]').daterangepicker({
		opens: 'left'
	  }, function(start, end, label) {
		  //alert("A new date range was chosen: " + start.format('MM-DD-YYYY') + ' to ' + end.format('MM-DD-YYYY'));
		  var daterange_ZMU = start.format('MM-DD-YYYY');
		  // alert(daterange_ZMU);
	  });
	});
	
	

    var form = document.getElementById("mainform")
      var input = document.getElementById("daterange")
      form.addEventListener('submit', function(e){
        input.value = daterange_ZMU
        form.submit()
      })



	var input = document.getElementById('daterange');
	var ___from___to___ = "{{ session['input_data_range']}}";
	input.value = ___from___to___;

	var myFunction_daterange = function (e) {
	  console.log(e.target.value);
	}



	
	var zmu_day_start = "{{ session['ZMU_day_start']}}"
	// alert(zmu_day_start);
		 
	var zmu_day_start = zmu_day_start.slice(0, 10);
	// alert(zmu_day_start);
		 
	document.addEventListener("DOMContentLoaded", function(){
    // var data_selezionata = "{{ session['ZMU_day_start'] }}";
	var data_selezionata_start = zmu_day_start;
	//alert(data_selezionata);
	document.getElementById('registrationday_start').value = data_selezionata_start;  
	});
	
	
	
	
	var zmu_day_end = "{{ session['ZMU_day_end']}}"
	//alert(zmu_day_end);
		 
	var zmu_day_end = zmu_day_end.slice(0, 10);
	// alert(zmu_day_end);
		 
	document.addEventListener("DOMContentLoaded", function(){
    // var data_selezionata_end = "{{ session['ZMU_day_end'] }}";
	var data_selezionata_end = zmu_day_end;
	// alert(data_selezionata);
	document.getElementById('registrationday_end').value = data_selezionata_end;  
	});
	
	  
	  
	  
	  
	 ///////////////////////////---------------------------------------------------------------------/////////////////////////////////////////////
	  ///////////////////////////---------------------------------------------------------------------////////////////////////////////////////////
	   ///////////////////////////---------------------------------------------------------------------///////////////////////////////////////////
	    ///////////////////////////---------------------------------------------------------------------//////////////////////////////////////////
	 
	// ADD Leaflet map
	
		
		const osm  = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
		})
         
	    var carto = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
         });
		 
		//const mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>';
		//const mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
		//const streets = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, attribution: mbAttr});

	
	// control that shows state info on hover
	const info = L.control(); 
	
	info.onAdd = function (map) {
	this._div = L.DomUtil.create('div', 'info');
	this.update();
	return this._div;
	};
		
	
   
	function getColor_hex_traffic(d) {
		return d >= 40 ? '#0c2c84' :
			d > 30  ? '#225ea8' :
			d > 15  ? '#1d91c0' :
			d > 12.5  ? '#41b6c4' :
			d > 10  ? '#7fcdbb' :
			d > 7.5  ? '#c7e9b4' :
			d > 5  ? '#edf8b1' :
			d >= 0   ? '#fdfdbf' : '#fdfdbf';
			} 
			
	function getColor_population_hex(d) {
		return d >= 100 ? '#2d2d4c' :
		    d > 95 ? '#3d3d66' :
		    d > 90 ? '#4c4c7f' :
		    d > 85 ? '#5b5b99' :
			d > 80 ? '#6b6bb2' :
			d > 75 ? '#7a7acc' :	
			d > 70 ? '#8989e5' :
		    d > 65 ? '#9999ff' :
		    d > 60 ? '#a3a3ff' :
			d > 55 ? '#adadff' :			
			d > 50 ? '#b7b7ff' :
			d > 45 ? '#c1c1ff' :
		    d > 40  ? '#ccccff' :  
		    d > 30  ? '#d6d6ff' :
			d > 20  ? '#e0e0ff' :
			d > 10  ? '#eaeaff' :
			d >= 0   ? '#f4f4ff' : '#ffffff';
			}
			
		
			
			
	function getColor_zmu_origin_destinations(d) {
		return d >= 2000 ? '#071a4f' :
		    d > 1000  ? '#0c2c84 ' :
		    d > 500  ? '#225ea8' : 
			d > 300  ? '#546ba8' :
			d > 100  ? '#1d91c0' :
			d > 70  ? '#41b6c4' :
			d > 45  ? '#7fcdbb' :
			d > 30  ? '#c7e9b4' :
			d > 15  ? '#d5df9f ' :
			d >= 5   ? '#fdfdbf' : '#fdfdbf';
			}  
			
			
	function getColor_census(d) {
		return d > 20000 ? '#800026' :
			d > 10000  ? '#97001e' :
			d > 5000  ? '#BD0026' :
			d > 3000  ? '#E31A1C' :
			d > 2000  ? '#FC4E2A' :
			d > 1000   ? '#FD8D3C' :
			d > 300   ? '#FEB24C' :
			d > 50   ? '#FED976' : '#FFEDA0';
				}
	
	
	function getColor_legend(d) {
		return d >= 15000 ? '#2d2d4c' :
		    d > 6000 ? '#3d3d66' :	
		    d > 3500 ? '#4c4c7f' :
			d > 2500 ? '#5b5b99' :
			d > 1500 ? '#6b6bb2' :				
			d > 1300 ? '#7a7acc' :	
		    d > 1000 ? '#8989e5' :	
		    d > 800 ? '#9999ff' :			
		    d > 600 ? '#a3a3ff' :	
            d > 500 ? '#adadff' :
			d > 300 ? '#b7b7ff' :
			d > 250 ? '#c1c1ff' :
		    d > 200 ? '#ccccff' :
			d > 100 ? '#d6d6ff' :
			d > 50   ? '#e0e0ff' :
			d > 20   ? '#eaeaff' :
			d >= 0   ? '#f4f4ff' : '#ffffff';
			}
	
	
	    /* LEGEND USED FOR THE HEXAGONAL TESSELLATION */
		var legend = L.control({position: 'bottomright'});
		
            legend.onAdd=function(map){
                var div=L.DomUtil.create('div','info legend');
							
				   const labels=["from 0 to 20",
								"from 20 to 50",
								"from 50 to 100",
								"from 100 to 200",
								"from 200 to 250",
								"from 250 to 300",
								"from 300 to 500",
								"from 500 to 600",
								"from 600 to 800",
								"from 800 to 1000",
								"from 1000 to 1300",
								"from 1300 to 1500",
								"from 1500 to 2500",
								"from 2500 to 3500",
								"from 3500 to 6000",
								"from 6000 to 15000",
								" > 15000"];
				 const grades = [0, 20, 50, 100, 200 ,250 , 300, 500, 600, 800, 1000, 1300, 1500, 2500, 3500, 6000, 15000];

                div.innerHTML='<div><b>Population(hex)</b></div';
				
			  for(var i=0; i <grades.length; i++){
					 div.innerHTML+='<i style="background:'+getColor_legend(grades[i]) + ' ">&nbsp;</i>&nbsp;&nbsp;' +labels[i]+'<br/>';        						 
                }
                return div;
            }
			
			
			/* LEGEND USED FOR CENSUARY DATA */
			var legend_censuary = L.control({position: 'bottomright'});
		
            legend_censuary.onAdd=function(map){
                var div=L.DomUtil.create('div','info legend');
							
				   const labels=["from 0 to 50",
								"from 50 to 300",
								"from 300 to 1000",
								"from 1000 to 2000",
								"from 2000 to 3000",
								"from 3000 to 5000",
								"from 5000 to 10000",
								"from 10000 to 20000",
								" > 20000"];
				 const grades = [0, 50, 300, 1000, 2000, 3000, 5000, 10000, 20000];

                div.innerHTML='<div><b>Population(zmu)</b></div';
				
			  for(var i=0; i <grades.length; i++){
					 div.innerHTML+='<i style="background:'+getColor_census(grades[i]) + ' ">&nbsp;</i>&nbsp;&nbsp;' +labels[i]+'<br/>';        						 
                }
                return div;
            }
            
		
		
			
	

	info.update = function (props) {
		const contents = props ? `<b>${props.POP_TOT_ZMU}</b> people` : 'Hover over a traffic zone';
		this._div.innerHTML = `<h4>Total Population Number</h4>${contents}`;
	};
	
	
	
		const selectedStyle = {
		  color: '#000000',
		  weight: 0.1,
		  opacity: 0.1,
		}
			
			
		const selectedStyle_highlight = {
		  color: 'black',
		  weight: 3,
		  opacity: 0.9,
		}
		
		
		const selectedStyle_highlight_ZONES = {
		  color: 'blue',
		  weight: 3,
		  opacity: 0.9,
		}
		
		
	
		
		const selectedStyle_mouseout = {
		  color: 'black',
		  weight: 2,
		  opacity: 0.1,
		}
		
		const selectedStyle_mouseout_ZONES = {
		  color: 'black',
		  weight: 1,
		  opacity: 0.9,
		}
		
	
				
				
		
	// get color depending on population number value

			function style_colors(feature) {
				return {
					weight: 0.1,
					opacity: 0.1,
					color: '#ffffff',
					dashArray: '2',
					fillOpacity: 0.7,
					fillColor: getColor_population_hex(feature.properties.percentile)
				};
			}
			
	
		
		
		
		function style_colors_zmu(feature) {
			return {
				weight: 0.5,
				opacity: 0.7,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.7,
				fillColor: getColor_zmu_origin_destinations(feature.properties.counts)
			};
		}
		
		
		function style_colors_POIS_ZMU(feature) {
			return {
				weight: 2,
				opacity: 0.3,
				color: 'black',
				dashArray: '3',
				fillOpacity: 0.1,
				fillColor: 'blue'
			};
		}
		
		
		
			function style_colors_ZMU_zones(feature) {
			return {
				weight: 1,
				opacity: 0.9,
				color: 'black',
				dashArray: '3',
				fillOpacity: 0.0,
				fillColor: 'white'
			};
		}
		
		
		
		
		
		function style_colors_POIS(feature) {
			return {
				weight: 0.5,
				opacity: 0.7,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.7,
				fillColor: 'blue'
			};
		}
		
		
		
		function style_colors_POIS_amenities(feature) {
			return {
				weight: 0.5,
				opacity: 0.7,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.7,
				fillColor: 'red'
			};
		}
		
		
		function style_colors_POIS_residential(feature) {
			return {
				weight: 0.5,
				opacity: 0.7,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.7,
				fillColor: 'yellow'
			};
		}
		
		
				
		
	    // used to color ZMU zones with population data 2011
		function style_pop(feature) {
			return {
				weight: 0.8,
				opacity: 1,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.5,
				fillColor: getColor_census(feature.properties.POP_TOT_ZMU)
			};
		}
		
		
		// used to highlight ZMU zones with population data 2011
		function style_ZMU_zones(feature) {
			return {
				weight: 0.8,
				opacity: 1,
				color: '#666',
				dashArray: '3',
				fillOpacity: 0.0,
				fillColor: getColor_census(feature.properties.POP_TOT_ZMU)
			};
		}
		
		

		function highlightFeature(e) {
			const layer = e.target;
			layer.setStyle({
				weight: 3,
				color: '#666',
				dashArray: '',
				fillOpacity: 0.9
			});

			layer.bringToFront();

			info.update(layer.feature.properties);
		}
		
		
         
		const censuary_default = L.geoJson(zmu_counts, {
				style: style_pop,
				onEachFeature
			});
			
		function onEachFeature(feature, layer) {
			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				//click: zoomToFeature
			});
		}
		
		function resetHighlight(e) {
			censuary_default.resetStyle(e.target);
			info.update();
		}

		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		}


		
		/// add ZMU zones  borders  /////////////////////////////////////////////////////
		var ZMU_zones = L.geoJSON(zmu_counts, { style: style_colors_ZMU_zones, 	
				  onEachFeature: function (feature, layer) {
				  layer.on('mouseover', function () {
				   layer.setStyle(selectedStyle_highlight_ZONES);
				  });
		var popupText = '';
					popupText += (feature.properties.POP_TOT_ZMU) ? '<h3>Population: ' + feature.properties.POP_TOT_ZMU : '';		
                    popupText += (feature.properties.quartiere) ? '<h3>Quartiere: ' + feature.properties.quartiere : '';
					popupText += (feature.properties.nome_comun) ? '<h3>Comune: ' + feature.properties.nome_comun : '';					
					layer.bindTooltip(popupText);		
		layer.on('mouseout', function (e) {
					layer.setStyle(selectedStyle_mouseout_ZONES); 
				});	
			}
			});

		
		
	 // alert("...I AM HERE...");
		
		
		
	    /*------------DEFAULT LAYER -----------------*/
	    const censuary_Layer = L.layerGroup();
		censuary_Layer.addLayer(censuary_default);		
	 
		const ZMU_zones_Layer = L.layerGroup();
		ZMU_zones_Layer.addLayer(ZMU_zones);	
			
	 
	

         /////////----------- Points of Interest (POIS) in ZMUs -------/////////////////////////////////////////	
		 
			 var POIS_ZMU = L.geoJSON(zmu_POIS_counts, { style: style_colors_POIS_ZMU, 	
				  onEachFeature: function (feature, layer) {
				  layer.on('mouseover', function () {
				   layer.setStyle(selectedStyle_highlight);
				  });
				  
					var popupText = '';
					popupText += (feature.properties.apartments) ? '<h3>Apartments: ' + feature.properties.apartments : '';
					popupText += (feature.properties.church) ? '<h3>Church: ' + feature.properties.church : ''
					popupText += (feature.properties.residential) ?  '<h3>Residential: ' + feature.properties.residential : '';
					popupText += (feature.properties.hotel) ? '<h3>Hotel: ' + feature.properties.hotel : ''
					popupText += (feature.properties.office) ? '<h3>Office: ' + feature.properties.office : ''
					popupText += (feature.properties.basilica) ? '<h3>Hotel: ' + feature.properties.basilica : ''
					popupText += (feature.properties.house) ? '<h3>House: ' + feature.properties.house : ''
					popupText += (feature.properties.public) ? '<h3>Public: ' + feature.properties.public : ''
					popupText += (feature.properties.market) ? '<h3>Market: ' + feature.properties.market : ''
					popupText += (feature.properties.detached) ? '<h3>Detached: ' + feature.properties.detached : ''
					popupText += (feature.properties.synagogue) ? '<h3>Synagogue: ' + feature.properties.synagogue : ''
					popupText += (feature.properties.roof) ? '<h3>Roof: ' + feature.properties.roof : ''
					popupText += (feature.properties.supermarket) ? '<h3>Supermarket: ' + feature.properties.supermarket : '';
					popupText += (feature.properties.retail) ? '<h3>Retail: ' + feature.properties.retail : ''
					popupText += (feature.properties.congress_centre) ? '<h3>Congress centre: ' + feature.properties.congress_centre : ''
					popupText += (feature.properties.government) ? '<h3>Government: ' + feature.properties.government : ''
					popupText += (feature.properties.commercial) ? '<h3>Commercial: ' + feature.properties.commercial : ''
					popupText += (feature.properties.semidetached_house) ? '<h3>Semidetached house: ' + feature.properties.semidetached_house : ''
					
					popupText += (feature.properties.arts_centre) ? '<h3>Arts centre: ' + feature.properties.arts_centre : ''
					popupText += (feature.properties.bus_station) ? '<h3>Bus station: ' + feature.properties.bus_station : ''
					popupText += (feature.properties.cafe) ? '<h3>Cafe: ' + feature.properties.cafe : ''
					popupText += (feature.properties.fast_food) ? '<h3>Fast food: ' + feature.properties.fast_food : ''
					popupText += (feature.properties.pharmacy) ? '<h3>Pharmacy: ' + feature.properties.pharmacy : ''
					popupText += (feature.properties.parking) ? '<h3>Parking: ' + feature.properties.parking : ''
					popupText += (feature.properties.place_of_worship) ? '<h3>Place of worship: ' + feature.properties.place_of_worship : ''
					popupText += (feature.properties.restaurant) ? '<h3>Restaurant: ' + feature.properties.restaurant : ''
					popupText += (feature.properties.bar) ? '<h3>Bar: ' + feature.properties.bar : ''
					popupText += (feature.properties.bicycle_parking) ? '<h3>Bicycle parking: ' + feature.properties.bicycle_parking : ''
					popupText += (feature.properties.charging_station) ? '<h3>Charging station: ' + feature.properties.charging_station : ''
					popupText += (feature.properties.theatre) ? '<h3>Theatre: ' + feature.properties.theatre : ''
					popupText += (feature.properties.cinema) ? '<h3>Cinema: ' + feature.properties.cinema : ''
					popupText += (feature.properties.library) ? '<h3>Library: ' + feature.properties.library : ''
					popupText += (feature.properties.marketplace) ? '<h3>Marketplace: ' + feature.properties.marketplace : ''
					popupText += (feature.properties.motorcycle_parking) ? '<h3>Motorcycle parking: ' + feature.properties.motorcycle_parking : ''
					popupText += (feature.properties.parking_entrance) ? '<h3>Parking entrance: ' + feature.properties.parking_entrance : ''
					popupText += (feature.properties.police) ? '<h3>Police: ' + feature.properties.police : ''
					popupText += (feature.properties.public_building) ? '<h3>Public building: ' + feature.properties.public_building : ''
					popupText += (feature.properties.school) ? '<h3>School: ' + feature.properties.school : ''
					popupText += (feature.properties.social_facility) ? '<h3>Social facility: ' + feature.properties.social_facility : ''
					popupText += (feature.properties.car_sharing) ? '<h3>Car sharing: ' + feature.properties.car_sharing : ''
					popupText += (feature.properties.pub) ? '<h3>Pub: ' + feature.properties.pub : ''
					popupText += (feature.properties.taxi) ? '<h3>Taxi: ' + feature.properties.taxi : ''
					popupText += (feature.properties.university) ? '<h3>University: ' + feature.properties.university : ''
					popupText += (feature.properties.college) ? '<h3>College: ' + feature.properties.college : ''
					popupText += (feature.properties.community_centre) ? '<h3>Community centre: ' + feature.properties.community_centre : ''
					popupText += (feature.properties.doctors) ? '<h3>Doctors: ' + feature.properties.doctors : ''
					popupText += (feature.properties.townhall) ? '<h3>Townhall: ' + feature.properties.townhall : ''
					popupText += (feature.properties.parking_space) ? '<h3>parking space: ' + feature.properties.parking_space : ''		
					popupText += (feature.properties.hospital) ? '<h3>Hospital: ' + feature.properties.hospital : '';
					popupText += (feature.properties.music_school) ? '<h3>Music school: ' + feature.properties.music_school : '';
					popupText += (feature.properties.fuel) ? '<h3>Fuel: ' + feature.properties.fuel : '';
					popupText += (feature.properties.car_rental) ? '<h3>Car rental: ' + feature.properties.car_rental : '';
					popupText += (feature.properties.dentist) ? '<h3>Dentist: ' + feature.properties.dentist : '';
					popupText += (feature.properties.clinic) ? '<h3>Clinic: ' + feature.properties.clinic : '';
					popupText += (feature.properties.social_centre) ? '<h3>Social centre: ' + feature.properties.social_centre : '';
					popupText += (feature.properties.events_venue) ? '<h3>Events venue: ' + feature.properties.events_venue : '';
					popupText += (feature.properties.research_institute) ? '<h3>Research institute: ' + feature.properties.research_institute : '';
					popupText += (feature.properties.ferry_terminal) ? '<h3>Ferry terminal: ' + feature.properties.ferry_terminal : '';
					popupText += (feature.properties.language_school) ? '<h3>Language school: ' + feature.properties.language_school : '';
					popupText += (feature.properties.kindergarten) ? '<h3>Kindergarten: ' + feature.properties.kindergarten : '';
					popupText += (feature.properties.conference_centre) ? '<h3>Conference centre: ' + feature.properties.conference_centre : '';
					popupText += (feature.properties.courthouse) ? '<h3>Courthouse: ' + feature.properties.courthouse : '';
					popupText += (feature.properties.tourism) ? '<h3>Tourism: ' + feature.properties.tourism : '';
					popupText += (feature.properties.weighbridge) ? '<h3>Weighbridge: ' + feature.properties.weighbridge : '';
					popupText += (feature.properties.childcare) ? '<h3>Childcare: ' + feature.properties.childcare : '';
					popupText += (feature.properties.nursing_home) ? '<h3>Nursing home: ' + feature.properties.nursing_home : '';
					popupText += (feature.properties.coworking_space) ? '<h3>Coworking space: ' + feature.properties.coworking_space : '';
					popupText += (feature.properties.casino) ? '<h3>Casino: ' + feature.properties.casino : '';
					popupText += (feature.properties.community_centres) ? '<h3>Community centres: ' + feature.properties.community_centres : '';
										
					layer.bindTooltip(popupText);
					
					
					
			layer.on('mouseout', function (e) {
						layer.setStyle(selectedStyle_mouseout); 
					});	
				}
				});
				
		const POIS_Layer_zmu = L.layerGroup();
		POIS_Layer_zmu.addLayer(POIS_ZMU);
		

		
		
		
		
		/////////----- ADD POINTS of INTERESTS (PARKINGS) nearby chosen location -----------////////////////////////
		var POIS_PARKING = L.geoJSON(POIS_parking, { style: style_colors_POIS, 	
			  onEachFeature: function (feature, layer) {
			  layer.on('mouseover', function () {
			   layer.setStyle(selectedStyle);
			  });
				layer.bindTooltip('<h3><p>amenity: '+feature.properties.amenity+'</p>');
				layer.on('mouseout', function (e) {
					layer.setStyle(style_colors_POIS); 
				});	
			}
			});
			
		
		const POIS_Layer = L.layerGroup();
		POIS_Layer.addLayer(POIS_PARKING);
		
		
		
	    /////////----- ADD POINTS of INTERESTS (all AMENITIES) nearby chosen location -----------////////////////////////
		var POIS_AMENITIES = L.geoJSON(POIS_amenities, { style: style_colors_POIS_amenities, 	
			  onEachFeature: function (feature, layer) {
			  layer.on('mouseover', function () {
			   layer.setStyle(selectedStyle);
			  });
				layer.bindTooltip('<h3><p>amenity: '+feature.properties.amenity+'</p>');
				layer.on('mouseout', function (e) {
					layer.setStyle(style_colors_POIS_amenities); 
				});	
			}
			});
			
		
		const POIS_Layer_amenities = L.layerGroup();
		POIS_Layer_amenities.addLayer(POIS_AMENITIES);
		
		
		
		/////////----- ADD POINTS of INTERESTS (all residential) nearby chosen location -----------////////////////////////
		var POIS_RESIDENTIALS = L.geoJSON(POIS_residential, { style: style_colors_POIS_residential, 	
			  onEachFeature: function (feature, layer) {
			  layer.on('mouseover', function () {
			   layer.setStyle(selectedStyle);
			  });
				layer.bindTooltip('<h3><p>building: '+feature.properties.building+'</p>');
				layer.on('mouseout', function (e) {
					layer.setStyle(style_colors_POIS_residential); 
				});	
			}
			});
			
		
		const POIS_Layer_residential = L.layerGroup();
		POIS_Layer_residential.addLayer(POIS_RESIDENTIALS);
		
		
		
		//////////////////////////-------------------------------////////////////////////////////////////
	   //////////////////////////////////////////////////////////////////////////////////////////////////
	  //////////////////////////////////////////////////////////////////////////////////////////////////
	 //////// ----- ADD HEATMAP data //////////////////////////////////////////////////////////////////
	 
	       
		var baseLayer = L.tileLayer(
          'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
            attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            maxZoom: 18
          }
        );  
		
		
		
       ////---------------------------------------------////////////////////////////////
	  //--------------------- NUMBER OF VEHICLES--------////////////////////////////////
	 
	   var N_destination_vehicles = {
		  data: gridded_destination_data
        }; 
		
		
		///// --------------------------------------------------------------////////
		///// -------------------- legend code ---------------------------- ////////
        // we want to display the gradient, so we have to draw it
		
		
        var legendCanvas_vehicles = document.createElement('canvas');
        legendCanvas_vehicles.width = 100;
        legendCanvas_vehicles.height = 10;

        var legendCtx_vehicles = legendCanvas_vehicles.getContext('2d');
        var gradientCfg_vehicles = {};

        function updateLegend_vehicles(data) {
          // the onExtremaChange callback gives us min, max, and the gradientConfig
          // so we can update the legend
          $('min_vehicles').innerHTML = data.min;
          $('max_vehicles').innerHTML = data.max;
          // regenerate gradient image
          if (data.gradient != gradientCfg_vehicles) {
            gradientCfg_vehicles = data.gradient;
            var gradient = legendCtx_vehicles.createLinearGradient(0, 0, 100, 1);
            for (var key in gradientCfg_vehicles) {
              gradient.addColorStop(key, gradientCfg_vehicles[key]);
            }

            legendCtx_vehicles.fillStyle = gradient;
            legendCtx_vehicles.fillRect(0, 0, 100, 10);
            $('gradient').src = legendCanvas_vehicles.toDataURL();
          }
        };
		
		 // create a heatmap instance This is for Number of Vehicles
        var heatmap_vehicles = h337.create({
          container: document.getElementById('heatmapContainer'),
          maxOpacity: .5,
          radius: 10,
          blur: .75,
          // update the legend whenever there's an extrema change
          onExtremaChange: function onExtremaChange(data) {
            updateLegend_vehicles(data);
          }
        }); 
		
		
		
		
	///////////--------------------------------------------/////////////////////////////
	///////////--------------------------------------------/////////////////////////////	
	////---------------------------------------------////////////////////////////////
	//////--------------------- TRIP TIME-------------////////////////////////////////
		
		var triptime = {
		  data: gridded_destination_triptime
        }; 
		
		
		var legendCanvas_triptime = document.createElement('canvas');
        legendCanvas_triptime.width = 100;
        legendCanvas_triptime.height = 10;

        var legendCtx_triptime = legendCanvas_triptime.getContext('2d');
        var gradientCfg_triptime = {};
		
		
		function updateLegend_triptime(data) {
          // the onExtremaChange callback gives us min, max, and the gradientConfig
          // so we can update the legend
          $('min_trip_time').innerHTML = data.min;
          $('max_trip_time').innerHTML = data.max;
          // regenerate gradient image
          if (data.gradient != gradientCfg_triptime) {
            gradientCfg_triptime = data.gradient;
            var gradient = legendCtx_triptime.createLinearGradient(0, 0, 100, 1);
            for (var key in gradientCfg_triptime) {
              gradient.addColorStop(key, gradientCfg_triptime[key]);
            }

            legendCtx_triptime.fillStyle = gradient;
            legendCtx_triptime.fillRect(0, 0, 100, 10);
            $('gradient_triptime').src = legendCanvas_triptime.toDataURL();
          }
        };
		
		
		 var heatmap_triptime = h337_triptime.create({
          container: document.getElementById('heatmapContainer'),
          maxOpacity: .5,
          radius: 10,
          blur: .75,
          // update the legend whenever there's an extrema change
          onExtremaChange: function onExtremaChange(data) {
            updateLegend_triptime(data);
          }
        }); 
		
		
		
	
		///////////--------------------------------------------/////////////////////////////
		///////////--------------------------------------------/////////////////////////////
		
	   ////---------------------------------------------////////////////////////////////
	  //////--------------------- STOP TIME-------------////////////////////////////////
		
		var stoptime = {
		  data: gridded_destination_stoptime
        }; 
		
			
		
		var legendCanvas_stoptime = document.createElement('canvas');
        legendCanvas_stoptime.width = 100;
        legendCanvas_stoptime.height = 10;


        var legendCtx_stoptime = legendCanvas_stoptime.getContext('2d');
        var gradientCfg_stoptime = {};
		
		
		function updateLegend_stoptime(data) {
          // the onExtremaChange callback gives us min, max, and the gradientConfig
          // so we can update the legend
          $('min_stop_time').innerHTML = data.min;
          $('max_stop_time').innerHTML = data.max;
          // regenerate gradient image
          if (data.gradient != gradientCfg_stoptime) {
            gradientCfg_stoptime = data.gradient;
            var gradient = legendCtx_stoptime.createLinearGradient(0, 0, 100, 1);
            for (var key in gradientCfg_stoptime) {
              gradient.addColorStop(key, gradientCfg_stoptime[key]);
            }

            legendCtx_stoptime.fillStyle = gradient;
            legendCtx_stoptime.fillRect(0, 0, 100, 10);
            $('gradient_stoptime').src = legendCanvas_stoptime.toDataURL();
          }
        };
		
		
		
		 var heatmap_stoptime = h337_stoptime.create({
          container: document.getElementById('heatmapContainer'),
          maxOpacity: .5,
          radius: 10,
          blur: .75,
          // update the legend whenever there's an extrema change
          onExtremaChange: function onExtremaChange(data) {
            updateLegend_stoptime(data);
          }
        }); 
		
		
		
		///////////--------------------------------------------/////////////////////////////
		///////////--------------------------------------------/////////////////////////////
		
	   ////---------------------------------------------////////////////////////////////
	  //////--------------------- TRIP DISTANCE-------------////////////////////////////
		
		var tripdistance = {
		  data: gridded_destination_tripdistance
        }; 
		
			
	
		var legendCanvas_tripdistance = document.createElement('canvas');
        legendCanvas_tripdistance.width = 100;
        legendCanvas_tripdistance.height = 10;

	
        var legendCtx_tripdistance = legendCanvas_tripdistance.getContext('2d');
        var gradientCfg_tripdistance = {};
		
	
		function updateLegend_tripdistance(data) {
          // the onExtremaChange callback gives us min, max, and the gradientConfig
          // so we can update the legend
          $('min_trip_distance').innerHTML = data.min;
          $('max_trip_distance').innerHTML = data.max;
          // regenerate gradient image
          if (data.gradient != gradientCfg_tripdistance) {
            gradientCfg_tripdistance = data.gradient;
            var gradient = legendCtx_tripdistance.createLinearGradient(0, 0, 100, 1);
            for (var key in gradientCfg_tripdistance) {
              gradient.addColorStop(key, gradientCfg_tripdistance[key]);
            }

            legendCtx_tripdistance.fillStyle = gradient;
            legendCtx_tripdistance.fillRect(0, 0, 100, 10);
            $('gradient_tripdistance').src = legendCanvas_tripdistance.toDataURL();
          }
        };
		
		
		
		 var heatmap_tripdistance = h337_tripdistance.create({
          container: document.getElementById('heatmapContainer'),
          maxOpacity: .5,
          radius: 10,
          blur: .75,
          // update the legend whenever there's an extrema change
          onExtremaChange: function onExtremaChange(data) {
            updateLegend_tripdistance(data);
          }
        }); 
     

	  //////////-------------------------------------------------/////////////////////	
	  //////////-------------------------------------------------/////////////////////
		
		
	
		

        var cfg_n_vehicles = {
          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
          "radius": 0.02,
          "maxOpacity": .8, 
          // scales the radius based on map zoom
          "scaleRadius": true, 
          // if set to false the heatmap uses the global maximum for colorization
          // if activated: uses the data maximum within the current map boundaries 
          //   (there will always be a red spot with useLocalExtremas true)
          "useLocalExtrema": true,
          // which field name in your data represents the latitude - default "lat"
          latField: 'lat',
          // which field name in your data represents the longitude - default "lng"
          lngField: 'lng',
          // which field name in your data represents the data value - default "value"
          valueField: 'count'
        };
		
		
		var cfg_triptime = {
          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
          "radius": 0.02,
          "maxOpacity": .8, 
          // scales the radius based on map zoom
          "scaleRadius": true, 
          // if set to false the heatmap uses the global maximum for colorization
          // if activated: uses the data maximum within the current map boundaries 
          //   (there will always be a red spot with useLocalExtremas true)
          "useLocalExtrema": true,
          // which field name in your data represents the latitude - default "lat"
          latField: 'lat',
          // which field name in your data represents the longitude - default "lng"
          lngField: 'lng',
          // which field name in your data represents the data value - default "value"
          valueField: 'triptime'
        };
		
		var cfg_stoptime = {
          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
          "radius": 0.02,
          "maxOpacity": .8, 
          // scales the radius based on map zoom
          "scaleRadius": true, 
          // if set to false the heatmap uses the global maximum for colorization
          // if activated: uses the data maximum within the current map boundaries 
          //   (there will always be a red spot with useLocalExtremas true)
          "useLocalExtrema": true,
          // which field name in your data represents the latitude - default "lat"
          latField: 'lat',
          // which field name in your data represents the longitude - default "lng"
          lngField: 'lng',
          // which field name in your data represents the data value - default "value"
          valueField: 'stoptime'
        };
		
		
	    var cfg_tripdistance = {
          // radius should be small ONLY if scaleRadius is true (or small radius is intended)
          "radius": 0.02,
          "maxOpacity": .8, 
          // scales the radius based on map zoom
          "scaleRadius": true, 
          // if set to false the heatmap uses the global maximum for colorization
          // if activated: uses the data maximum within the current map boundaries 
          //   (there will always be a red spot with useLocalExtremas true)
          "useLocalExtrema": true,
          // which field name in your data represents the latitude - default "lat"
          latField: 'lat',
          // which field name in your data represents the longitude - default "lng"
          lngField: 'lng',
          // which field name in your data represents the data value - default "value"
          valueField: 'tripdistance'
        };


        var heatmapLayer_n_vehicles = new HeatmapOverlay(cfg_n_vehicles);
		var heatmapLayer_triptime = new HeatmapOverlay_triptime(cfg_triptime);
		var heatmapLayer_stoptime = new HeatmapOverlay_stoptime(cfg_stoptime);
		var heatmapLayer_tripdistance = new HeatmapOverlay_tripdistance(cfg_tripdistance);

       
	   
       //////------------ to be used for the legend  of Number of Vehicles----------////////////////////
		var width = 50
		var height = 50
		var max_vehicles = max_n_vehicles;
		var min_vehicles = min_n_vehicles;
		
			
	  heatmap_vehicles.setData({
		min: min_vehicles,
		max: max_vehicles,
		data: gridded_destination_data
	  });  
	  ////////////---------------------------------------------------------------- ////////////////////
	  
	  
	  //////------------ to be used for legend of trip time -----------------------------//////////////
		var width = 50
		var height = 50
		var max_trip_time = max_triptime;
		var min_trip_time = min_triptime;
		
			
	  heatmap_triptime.setData({
		min: min_trip_time,
		max: max_trip_time,
		data: gridded_destination_triptime
	  });  
	 ////////////---------------------------------------------------------------- ////////////////////
	 
	 
	   //////------------ to be used for legend of stop time -----------------------------//////////////
		var width = 50
		var height = 50
		var max_stop_time = max_stoptime;
		var min_stop_time = min_stoptime;
		
			
	  heatmap_stoptime.setData({
		min: min_stop_time,
		max: max_stop_time,
		data: gridded_destination_stoptime
	  });  
	 ////////////---------------------------------------------------------------- ////////////////////
	 
	 
	 //////------------ to be used for legend of trip distance --------------------------//////////////
		var width = 50
		var height = 50
		var max_trip_distance = max_tripdistance;
		var min_trip_distance = min_tripdistance;
		
			
	  heatmap_tripdistance.setData({
		min: min_trip_distance,
		max: max_trip_distance,
		data: gridded_destination_tripdistance
	  });  
	 ////////////---------------------------------------------------------------- ////////////////////
	 
	 
	
		  
		
    /////////---------------------------------/////////////////////////////////////////	
    /////////---------------------------------/////////////////////////////////////////	
    /////////---------------------------------/////////////////////////////////////////	
	

	  var map = new L.Map('map', {
          center: new L.LatLng(41.8946, 12.4873),
          zoom: 11,
         layers: [baseLayer, heatmapLayer_n_vehicles, ZMU_zones_Layer]
        }); 
		

        heatmapLayer_n_vehicles.setData(N_destination_vehicles);
		heatmapLayer_triptime.setData(triptime);
		heatmapLayer_stoptime.setData(stoptime);
	    heatmapLayer_tripdistance.setData(tripdistance);

		
		//legend.addTo(map);
		//legend_censuary.addTo(map);
		// info.addTo(map);
		
	

	
	//------------------------- choose location on the map manually...

	 map.on('click', 
			function(e){
				document.getElementById('lat').value = e.latlng.lat;
				document.getElementById('lng').value = e.latlng.lng;
				  
				var newMarker = L.marker(e.latlng, {draggable:'true'}).addTo(map)	
    });
		
		
		
		{% for marker in markers %}
		L.marker([{{ marker['lat'] }}, {{ marker['lon'] }}]).addTo(map)
		.bindPopup("{{ marker['popup'] }}")
		.openPopup();
		{% endfor %}
		
		
		
		const baseLayers = {
			//'Streets': streets,
			'OpenStreetMap': osm,
			'Carto': carto
		};
		
		const overlays = {
		    //'Traffic Zones & Population': censuary_Layer,
			'Traffic Zones': ZMU_zones_Layer,
			'num. vehicles @DESTINATION': heatmapLayer_n_vehicles,
			'stop time (min) @DESTINATION': heatmapLayer_stoptime,
			'trip distance (km) @DESTINATION': heatmapLayer_tripdistance,
			'trip time (min) @DESTINATION': heatmapLayer_triptime,
			'POIS & Residences': POIS_Layer_zmu,
			'POIS_Parking': POIS_PARKING,
			'POIS_Amenities': POIS_AMENITIES,
			'POIS_Residentials': POIS_RESIDENTIALS
			
		};
		
		


		const layerControl = L.control.layers(baseLayers, overlays ,{collapsed:false,}).addTo(map);	

		const cens_layer = L.layerGroup([censuary_default]);	
		const satellite = L.tileLayer(mbUrl, {id: 'mapbox/satellite-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr});
		layerControl.addBaseLayer(satellite, 'Satellite');
		layerControl.addOverlay(POIS_PARKING, 'parkings');
		layerControl.addOverlay(POIS_AMENITIES, 'amenities');
		layerControl.addOverlay(POIS_RESIDENTIALS, 'buildings')
		
		
	
	
	window.addEventListener('resize', 
	() => map.getViewPort().resize());
	
};

  </script>
</body>
</html>